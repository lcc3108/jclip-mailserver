language: node_js
node_js:
  - "8"
cache:
  npm: true
  yarn: true
  directories:
    - "$HOME/terraform"
env:
  global:
    - secure: u/HzrwprkJfz2cYSvgP1eOJULm4c2x01IZ1caqZzGXtuTWPX9X/8+BkjAYdTb6+sNcVy2GpYEkoZ7j2E8FpyzXE+S9vJEsnZ8X8gYXm9QS/aWT8in7iH9THgwMmgUA9lLaPgI8fF2BlAJsqux9887BJJyjHB2VhPtZYlzwfXAeIgj7mxHJwBgr5xPwKEDowTfxN/X3aaAVsLl6ZCflk1bsmj0KyevAIG5Fnwr1GVXVP6VQcyXQOx4ZpWJf8mOOWndEQHakOqRb9z8i8P1dJgBnjnwxymk+YmM1X3ePN/oOU4sKH0i/DblJkoSsSeDqAcQHNdjI+RINBEUxDliAspybNdkEOhTGnuJxo3V/TVmyqTAJnoBqC/B3WIzb8cCVPDRoQ9zeYD8Wc7HfgNmyeVlNZLAm7Y290ARJdTpK9czNaJXUZ2+yXtS6/22d0ZTMY2LyLxP2Gs4PAXUECQuObQ8DKuztdUrINLHiF46pr5Qo4129JpuSXbizAU7wHiCNPoVeBj28rv8TVUa5gBcekUW3JvHLmjGYw92puMygSx0ucihpbilsSZ+MwuryUEM7NfwHvcXXNAlWo78nLMtu0N53OhNnDkAjAUBEbJhbj2wRRaGUOnAhFLtBYT4UOIq3WjgH77bLWzOM2riIHLJOl7D9Cqoiczvvz8wKsGXITBO6I=
    - secure: gLQp52178lk0pPLyiaHLNaiY00wCwy6YfYxfqtOI7zfhjCjwoqrOLaFu1QrJOjs9fGOJsu4AyqlgbbrGlI9vu3DnGDsXCVLvNIj5luWaYGnevREwxCaWpyvIoLvLZsr99a2jTLRvVq8KbrMHor6+Gk7a3qiYcMJ0D1hu2zP6voeyP8S3AqXmaprsd8X9GbAjb4SxRrmEWr5TJx4K98+ff6icmALLD69243jzh/lMn4vG+hrRqoLPeJHycZhvNC7n55JBJ1pNvIR1niiW76rNFRmkKUxR52qGmKc70AdqQBv9m9P+S7ie3cp5pRpErMIsdd/BNzuIm1+S6C+3XYBW5B5AJPpFFwwYmxIZCUdp7F5yC+06TJkkdxGtImbRpGO+AU/VT0FqzwADAH3jHMtO+f+gNSJXWR0aFapvBaYjJHaz29l+TPF89FFCnBapI8ePVnkFQnD+QOFdRH/dJaojKnk26M7hEWoJEc/d6o9R9LA80CHowEOty1azkj/mVKkob9pkRewNd2Ex0UEhqkWKHU5d3LbTvT21B9i6cBREUdycdhivNzTsmmZKFTWXa3myx7n9GZ/6xk+fKlz8tFolr6dNe3BnJIJu1J5dCw5BZk/zS07eGJH82Qya/efJBgTjwCYz4svsNwAwswQmRQPW48oi+DLxgBgvmfxmwc+CZAk=
    - secure: 2T+why6MSVDYZfYagUX1R61xqw1c23b7plCZDRHSqPeVFWXaK27HVwP7+EZZgo54mRmbrp2hyHjvro2l4oG/d2aEu28adGZ5YY/Wbg+LOc2xI6U5cK/9yPtTLiiGXXCbDCehIqoQKcdhWtfWGo0niN9UcDK1NYjSx8BsG402BjYgTgesjda6VvwFeaHNmwfgiGi+XYRWTEBwPFdW0+du1QMrFUHZxKFPAkW6JGz3Xl0JNWcLCidd9tyhMOw+HZxVpVClYvtYhbasl++oQvQ77mmWrdmxxpmjiF4RazpqT4skxZAsgp7DFK7q71r0wnJeQOXbH8uSwLAoqGHHlt9MZi5GftW0OqdUDGLloIuKXLoMI3mNwnXoUCwFXx6dCjlcXJx63taV+u65yAaOMJ1surzoPLPO0RPpKOROyvBCasrx5ybfXxG3GxZf0uEGBVqP3lhIaxGLMTKNDb3eXmqSCwaGREAsJp+CdFtcOEdLRtUpF2hrVTY/fkLTo7FBO7ecU6xHGqqLS9Y7xlnFm89jxyKiq8UPt/lxSsL/N1VOvNo5i2aB3QmW7I8/K0dxR+4Cx7i/KHz5JxrjJAfH2Q13ANhwPHHVKL1dhiiHncUfLUd31XmREHfCA+GtLc3lAK98xX6SzJS6ifkRxGlInVJJbhBfPwUZ70RJBxHKzVJr5A8=
before_install:
  - openssl aes-256-cbc -K $encrypted_3e39b73e0d5c_key -iv $encrypted_3e39b73e0d5c_iv
    -in private.tar.enc -out private.tar -d
  - tar xvf private.tar
  - |
    if [ ! -d "$HOME/terraform/bin" ]; then
      rm -rf "$HOME/terraform"
      mkdir -p $HOME/terraform/bin
      wget https://releases.hashicorp.com/terraform/0.12.16/terraform_0.12.16_linux_amd64.zip
      unzip terraform_0.12.16_linux_amd64.zip -d $HOME/terraform/bin/
    fi
  - export PATH=$PATH:$HOME/terraform/bin
install:
  - yarn
jobs:
  include:
    - stage: test
      script:
        - yarn lint
        - yarn type-check
        - yarn build
    - stage: deploy
      env: CLOUD=AWS
      script:
        - yarn build
      before_deploy:
        - echo credentials \"app.terraform.io\" { token = \"$TOKEN\" } | cat >> ~/.terraformrc
        - cp -r ./node_modules ./dist/
        - terraform init
      deploy:
        - provider: script
          script: yarn deploy
          skip_cleanup: true
          on:
            branch: jwt
